<!DOCTYPE html>
<html lang="zh">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <a href="/profile" class="profile-icon" title="查看个人资料">
        <i class="fa-regular fa-circle-user"></i>
    </a>
    
    <title>闪耀盒子美容计划定制</title>
    <style>
        body {
            font-family: 'Comic Sans MS', sans-serif;
            margin: 0;
            padding: 20px;
            background-image: url('https://www.optimumpmr.com/wp-content/uploads/2022/02/AdobeStock_190889654-scaled.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white */
            border-radius: 12px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #A0522D; /* Soft brown */
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #4B3D3D; /* Soft gray */
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #D3CFCF; /* Light gray */
            border-radius: 5px;
            background-color: #F9F5F5; /* Very light gray */
        }
        .button {
            background-color: #C8A2C8; /* Soft mauve */
            color: white;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 130px;
            height: 50px;
            border: 2px solid #e6d7f2; /* Soft lavender */
            border-radius: 12px;
            background-color: #f3eefc; /* Light lavender */
            transition: background-color 0.3s, border-color 0.3s;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-container:hover {
            border-color: #D3A2D3; /* Light mauve on hover */
            background-color: #f3eefc; /* Lighter lavender */
        }
        
        .checkbox-container input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: #A0522D; /* Soft brown */
        }
    
        .range-container {
            display: flex;
            align-items: center;
        }

        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 80%;
            height: 12px;
            background: #D3CFCF; /* Light gray */
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            margin-right: 15px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #C8A2C8; /* Soft mauve */
            border-radius: 50%;
            cursor: pointer;
        }
        
        output {
            font-size: 18px;
            font-weight: bold;
            color: #A0522D; /* Soft brown */
        }
    </style>
</head>
<body>
<div class="container">

<h1>闪耀盒子美容计划定制</h1>

<div class="input-group">
    <label for="height">身高 (cm)</label>
    <div class="range-container">
        <input type="range" id="height" min="140" max="200" step="1" value="170" oninput="this.nextElementSibling.value = this.value" required>
        <output>170</output>
    </div>
</div>

<div class="input-group">
    <label for="weight">体重 (kg)</label>
    <div class="range-container">
        <input type="range" id="weight" min="40" max="120" step="1" value="60" oninput="this.nextElementSibling.value = this.value" required>
        <output>60</output>
    </div>
</div>

<div class="input-group">
    <label for="gender">性别</label>
    <select id="gender" required>
        <option value="" disabled selected>请选择性别</option>
        <option value="male">男</option>
        <option value="female">女</option>
        <option value="other">其他</option>
    </select>
</div>

<div class="input-group">
    <label for="age">年龄</label>
    <input type="range" id="age" min="18" max="100" step="1" value="25" oninput="this.nextElementSibling.value = this.value" required>
    <output>25</output>
</div>

<div class="input-group">
    <label for="skin-type">肤质</label>
    <select id="skin-type" required>
        <option value="" disabled selected>请选择肤质</option>
        <option value="中性">中性</option>
        <option value="油">油</option>
        <option value="干">干</option>
        <option value="混油">混油</option>
        <option value="混干">混干</option>
    </select>
</div>

<div class="input-group">
    <label for="allergies">过敏史</label>
    <input type="text" id="allergies" placeholder="例如：花生，花粉">
</div>

<div class="input-group">
    <label for="disease">疾病史</label>
    <input type="text" id="disease" placeholder="例如：糖尿病，高血压">
</div>

<div class="input-group">
    <label for="health-aspect">想要改善的方面</label>
    <div class="checkbox-group">
        <label class="checkbox-container">
            <input type="checkbox" id="wantProblem1" value="瘦身">
            <span>瘦身</span>
        </label>
        <label class="checkbox-container">
            <input type="checkbox" id="wantProblem2" value="美白焕肤">
            <span>美白焕肤</span>
        </label>
        <label class="checkbox-container">
            <input type="checkbox" id="wantProblem3" value="抗老">
            <span>抗老</span>
        </label>
        <label class="checkbox-container">
            <input type="checkbox" id="wantProblem4" value="女性调养">
            <span>女性调养</span>
        </label>
    </div>
    <button class="button" onclick="showCurrentProblems()">确认选择</button>
</div>

<div class="input-group" id="current-problems-group" style="display: none;">
    <label for="current-problems">想要改善的问题</label>
    <div class="checkbox-group" id="current-problems-checkboxes"></div>
</div>

<button class="button" onclick="generatePlan()" style="display: none;">生成计划</button>
<div id="loading-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
    <div class="loader"></div>
    <p style="color: red; margin-top: 10px;">正在生成你的变美计划...</p>
</div>
    <div class="product-list" id="product-list" style="display: none;">
        <h2>闪耀盒子美容计划</h2>
        <div id="products"></div>
        <div class="total-price" id="total-price"></div>
        <button class="button" onclick="purchase()">Purchase</button>
    </div>

</div>

<script>
    const currentProblems = {
        '瘦身': [
            '消水肿',
            '降体脂',
            '提高基础代谢'
        ],
        '美白焕肤': [
            '祛斑',
            '祛痘',
            '亮肤'
        ],
        '抗老': [
            '祛皱',
            '紧致提拉',
            '改善肤色'
        ],
        '女性调养': [
            '月经调理',
            '内分泌调理',
            '补气血'
        ]
    };

    function showCurrentProblems() {
        const selectedProblems = Array.from(document.querySelectorAll('.checkbox-container input:checked')).map(input => input.value);
        const currentProblemsDiv = document.getElementById('current-problems-checkboxes');
        currentProblemsDiv.innerHTML = ''; // 清空现有问题选项
    
        const confirmButton = document.querySelector('.button[onclick="showCurrentProblems()"]'); // 确认选择按钮
        const generatePlanButton = document.querySelector('.button[onclick="generatePlan()"]'); // 生成计划按钮
    
        if (selectedProblems.length > 0) {
            selectedProblems.forEach(problem => {
                if (currentProblems[problem]) {
                    currentProblems[problem].forEach(option => {
                        currentProblemsDiv.innerHTML += `
                            <label class="checkbox-container">
                                <input type="checkbox" value="${option}">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                }
            });
            document.getElementById('current-problems-group').style.display = 'block'; // 显示现有问题部分
            
            confirmButton.style.display = 'none';
            generatePlanButton.style.display = 'block';
        } else {
            alert("请至少选择一个想要改善的问题。");
        }
    }

    async function generatePlan() {
        const height = document.getElementById("height").value;
        const weight = document.getElementById("weight").value;
        const gender = document.getElementById("gender").value;
        const age = document.getElementById("age").value;
        const skinType = document.getElementById("skin-type").value;
        const allergies = document.getElementById("allergies").value;
        const diseaseHistory = document.getElementById("disease").value;

        const healthAspect = [...document.querySelectorAll('input[type="checkbox"]:checked[id^="wantProblem"]')]
            .map(cb => cb.value)
            .join(', ');

        const currentProblems = [...document.querySelectorAll('#current-problems-group input[type="checkbox"]:checked')]
            .map(cb => cb.value)
            .join(', ');

        const prompt = `
            用户健康数据：
            - 身高: ${height} cm
            - 体重: ${weight} kg
            - 性别: ${gender}
            - 年龄: ${age}
            - 肤质: ${skinType}
            - 过敏史: ${allergies}
            - 疾病史: ${diseaseHistory}
            - 想要改善的健康方面: ${healthAspect}
            - 现有问题: ${currentProblems}
            
            基于以上信息，请基于我们现有的产品推荐适合的补品。
            根据不同的需求，我们有以下产品：
            美白换肤：
            1. 维生素C
            2. 传明酸
            3. 维生素E
            4. 胶原蛋白肽
            5. 硫辛酸
            6. 葡萄籽提取物
            瘦身塑形：
            1. 左旋肉碱
            2. 共轭亚油酸（CLA）
            3. 绿茶提取物胶囊
            4. 纤维补充剂
            5. 益生菌粉
            抗老：
            1. 辅酶Q10
            2. 胶原蛋白肽
            3. Omega-3鱼油
            4. 透明质酸
            5. 视黄醇
            6. 谷胱甘肽
            7. 钙镁锌+D3
            女性调养：
            1. 月见草油
            2. 蔓越莓胶囊
            3. 祛湿丸
            4. 钙镁锌+D3
            5. 当归补血丸
            6. 丹参片
            7. 黄芪提取物

            以该格式生成计划，每个需求推荐1-2种补品，不要重复，除了推荐列表不要包括其他的文字：\n
            补品1名字 剂量：x次/天 y粒/次
            主要功效：...
            补品2名字 剂量：x次/天 y粒/次
            主要功效：...
            补品3名字 剂量：x次/天 y粒/次
            主要功效：...
            ...

        `;
        console.log(prompt);
        document.getElementById("loading-container").style.display = "flex";
        try {
            const response = await fetch('/generate-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ prompt })
            });
    
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
    
            const data = await response.json();
            localStorage.setItem('gptProducts', data.products);
            window.location.href = '/plan';
        } catch (error) {
            console.error("Error calling the API:", error);
            alert("There was an error generating the plan. Please try again.");
        }
    }
</script>
</div>
</body>
</html>